---
title: "Simulations of chromosome numbers"
author: "Natalie Cooper"
output: html_document
---

## Looking at phylogenetic patterns using simulations

```{r, message = FALSE}
# Load libraries
library(tidyverse)
library(here)
library(phytools)
library(ChromEvol) #install this from source
library(patchwork)
```

Read in all the simulations outputs, wrangle into a useable format, and combine.
```{r, message = FALSE, warning = FALSE}
sim_output <- data.frame(haploidn = NULL, tips = NULL, sim = NULL)

# Loop through all 1000 folders of outputs
for (i in 0:999) {
  # Choose directory
  dir <- paste0("chromEvol/chromEvol_out_simulations/", i, "/")
  # Read in counts data
  counts <- read_delim(here(paste0(dir,"simCounts.txt")), 
                       delim = "\t", col_names = FALSE)

  # wrangle and add sim number
  countdata <- 
  counts %>%
  mutate(ind = rep(c("tips","haploidn"), length.out = n())) %>%
  group_by(ind) %>%
  mutate(id = row_number()) %>%
  spread(ind, X1) %>%
  dplyr::select(-id) %>%
  mutate(tips = gsub(">", "", tips)) %>%
  mutate(sim = rep(i+1, length(tips)))
  
  # add to output
  sim_output <- rbind(sim_output, countdata)
}

sim_output$sim <- sim_output$sim+1

#write_csv(sim_output, path = here("data/chromevol-simulations-outputs.csv"))
```

Add the observed data to the simulations data, then work out the differences between observed numbers and simulation numbers of chromosomes.
```{r}
# Read in observed data
mydata <- read_csv(here("data/chromosome-data.csv"))

# Rename the haploidn column
# Select only tip names, genus and observed haploidn
mydata <-
  mydata %>%
  rename(obs_haploidn = haploidn) %>%
  dplyr::select(tips, obs_haploidn, genus)

# Join data by tip names
sim_output2 <- 
  full_join(sim_output, mydata, by = "tips")

# Calculate differences
results <- 
  sim_output2 %>%
  mutate(haploidn = as.numeric(haploidn)) %>%
  mutate(diff = obs_haploidn - haploidn)

# Remove the outgroup
results <- filter(results, genus != "Leiolepis")
```

## Null model simulations

Create null simulations by randomly assigning chromosome numbers to the tips. The numbers come from the data and sampling is done without replacement.
```{r}
sims_output_null <- data.frame(sim_haploidn = NULL, tips = NULL, sim = NULL)
  
for (j in 1:1000){
  newdata <- data.frame(sim_haploidn = sample(mydata$obs_haploidn, 
                                              length(mydata$tips)),
                        tips = mydata$tips, 
                        sim = rep(j, length(mydata$tips)))

  sims_output_null <- rbind(sims_output_null, newdata)
}

#write_csv(sims_output_null, path = here("data/null-simulations-outputs.csv"))
```

Add the data so the differences between observed and simualted chromosome numbers can be calculated.
```{r}
# Join data by tip names
sim_output_null2 <- 
  full_join(sims_output_null, mydata, by = "tips")

# Calculate differences
results_null <- 
  sim_output_null2 %>%
  mutate(diff = obs_haploidn - sim_haploidn)

# Remove the outgroup
results_null <- filter(results_null, genus != "Leiolepis")
```

## Plot the observed versus the simulations for both sets
```{r}
ggplot(results, aes(x = diff)) +
  geom_density(colour = "cornflowerblue") +
  geom_density(data = results_null, colour = "grey") +
  geom_vline(xintercept = 0, linetype = "dotted") +
  facet_wrap(~genus) +
  theme_bw(base_size = 14) +
  theme(strip.background = element_rect(fill="white"), 
        strip.text = element_text(face = "italic"),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab(expression(n[observed] - n[simulated]))

#ggsave(filename = here("outputs/all-simulations-differences.png"))  

```
Plot number of chromosomes predicted using chromosome evolution models
```{r}
  ggplot(results_null, aes(x = sim_haploidn)) +
  # Add null as this is the true distribution
  geom_histogram(binwidth = 1, alpha = 0.5) +
  # Add simulations in blue
  geom_histogram(data = results, aes(x = haploidn), 
                 fill = "cornflowerblue", binwidth = 1, alpha = 0.5) +
  theme_bw(base_size = 14) +
  xlab("chromosomes (n)") +
  coord_cartesian(xlim = c(0, 45), ylim = c(0,60000))

#ggsave(filename = here("outputs/chromevol-simulations-numbers.png"))  
```