---
title: "Taxa and species pairs analyses"
author: "Natalie Cooper"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE}
# Load libraries
library(tidyverse)
library(here)
library(ape)
library(phangorn)
```

Read in the data and the tree
```{r, message = FALSE, echo = FALSE}
mydata <- read_csv(here("data/chromosome-data.csv"))
mytree <- read.tree(here("data/ML-tree.tre"))
```

Take a look at the dataset and tree
```{r}
#str(mytree)
#head(mydata)
```

Initially we use the phylogeny as is, and use OTUs which are often within the same species. As a test, we correlated the difference in haploid chromosome number with phylogenetic distance.

1. Look at all pairs of taxa at the tips. 

This is the simplest solution in many ways, but does introduce a large amount of pseudoreplication as each tip taxon appears a huge number of times.
```{r}
# Get species pairs
all.pairs <- expand.grid(tip1 = mydata$tips,
	                       tip2 = mydata$tips)

# Combine with the chromosome data...
all.pairs  <- left_join(all.pairs, mydata, by = c("tip1" = "tips"))
all.pairs  <- left_join(all.pairs, mydata, by = c("tip2" = "tips"))

# Find cophenetic distances for whole tree
phylo_matrix <- cophenetic.phylo(mytree)

# Flatten matrix
phylo.dist.all <- 
  data.frame(expand.grid(tip1 = dimnames(phylo_matrix)[[1]],
	                       tip2 = dimnames(phylo_matrix)[[2]]),
             phylodist = c(phylo_matrix))

# Add to pairs data
# warns about adding vectors and factors - this is fine here
pairs.data <- 
  left_join(phylo.dist.all, all.pairs, by = c("tip1","tip2")) %>% 
  filter(phylodist > 0)

# Exclude outgroup
pairs.data <-
  pairs.data %>%
  filter(tip1 != "Leiolep" & tip2 != "Leiolep")
```

Now work out the differences in chromosome numbers
```{r}
pairs.data2 <-
  pairs.data %>%
  mutate(haploid_diff = abs(haploidn.x - haploidn.y))
```

And plot...
```{r}
# hex plot  
ggplot(pairs.data2, aes(x = phylodist, y = haploid_diff)) +
  geom_hex(alpha = 0.8, bins = 20) +
  theme_bw(base_size = 14) +
  scale_fill_viridis_c(trans = "log10", option = "plasma") +
  theme(strip.background = element_rect(fill = "white")) +
  xlab("phylogenetic distance (Ma)") +
  ylab("difference in chromosome number (n)")

#ggsave(filename = here("outputs/taxon-pairs-distances.png"), height = 5)
```

2. Look at all pairs of species at the tips. 

We can do the same thing but collapsing the OTUs down into species.

First remove excess data from my data, selecting just the first time each species appears and using these tip taxa only.
```{r}
mydata_species <-
  mydata %>% 
  mutate(dup = duplicated(mydata$Binomial)) %>%
  filter(dup != TRUE)

# Remove species from the tree that are not in mydata_species
remove <- setdiff(mytree$tip.label, mydata_species$tips)
speciestree <- drop.tip(mytree, remove)
```

```{r}
# Get species pairs
all.pairs_species <- expand.grid(tip1 = mydata_species$tips,
	                       tip2 = mydata_species$tips)

# Combine with the chromosome data...
all.pairs_species  <- left_join(all.pairs_species, mydata_species, by = c("tip1" = "tips"))
all.pairs_species  <- left_join(all.pairs_species, mydata_species, by = c("tip2" = "tips"))

# Find cophenetic distances for whole tree
phylo_matrix_species <- cophenetic.phylo(speciestree)

# Flatten matrix
phylo.dist.all_species <- 
  data.frame(expand.grid(tip1 = dimnames(phylo_matrix_species)[[1]],
	                       tip2 = dimnames(phylo_matrix_species)[[2]]),
             phylodist = c(phylo_matrix_species))

# Add to pairs data
# warns about adding vectors and factors - this is fine here
pairs.data_species <- 
  left_join(phylo.dist.all_species, all.pairs_species, by = c("tip1","tip2")) %>% 
  filter(phylodist > 0)

# Exclude outgroup
pairs.data_species <-
  pairs.data_species %>%
  filter(tip1 != "Leiolep" & tip2 != "Leiolep")
```

Now work out the differences in chromosome numbers
```{r}
pairs.data2_species <-
  pairs.data_species %>%
  mutate(haploid_diff = abs(haploidn.x - haploidn.y))
```

And plot...
```{r}
# hex plot
ggplot(pairs.data2_species, aes(x = phylodist, y = haploid_diff)) +
  geom_hex(alpha = 0.8, bins = 20) +
  theme_bw(base_size = 14) +
  scale_fill_viridis_c(trans = "log10", option = "plasma") +
  theme(strip.background = element_rect(fill = "white")) +
  xlab("phylogenetic distance (Ma)") +
  ylab("difference in chromosome number (n)")

#ggsave(filename = here("outputs/species-pairs-distances.png"), height = 5)
```

